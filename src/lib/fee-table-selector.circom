include "../../node_modules/circomlib/circuits/mux4.circom";
include "../../node_modules/circomlib/circuits/bitify.circom";

/**
 * Selects fee to apply given the fee selector
 */
template FeeTableSelector() {
    signal input feeSel;
    signal output feeOut;

    component n2bFeeSel = Num2Bits(8);
    n2bFeeSel.in <== feeSel;

    var table[256] = feeShiftTable();

    component mux[17];
    var i;
    var j;

    // Initialize mux4 components
    for (i = 0; i < 17; i++){
        mux[i] = Mux4();
    }

    // set first mux level (mux[0]...mux[15])
    // selectors
    for (i = 0; i < 16; i++){
        for (j = 0; j < 4; j++){
            mux[i].s[j] <== n2bFeeSel.out[j];
        }
    }
    // inputs
    var nMux = 0;
    for (i = 0; i < 256; i++){
        if ((i != 0) && (i % 16 == 0)){
            nMux = nMux + 1;
        }
        mux[nMux].c[i % 16] <== table[i];
    }

    // set second mux level (mux[16])
    // selectors
    for (i = 0; i < 4; i++){
        mux[16].s[i] <== n2bFeeSel.out[4 + i];
    }
    // inputs
    for (i = 0; i < 16; i++){
        mux[16].c[i] <== mux[i].out;
    }

    mux[16].out ==> feeOut;
}

/**
 * Fee table hardcoded values
 * Table: (fee2Apply) * 2**bitsShift
 * Chosen bitShift = 79, which is the minimum value to have precision for each fee applied
 */
function feeShiftTable() {
    var out[256] = [0, 1, 6, 19, 60, 191, 604, 1911, 6044, 19114, 60446, 191147, 604462, 1911479, 6044629, 19114795, 60446290, 191147955, 604462909, 1911479556, 6044629098, 19114795560, 60446290980, 191147955608, 604462909807, 1911479556084, 6044629098073, 19114795560840, 60446290980731, 191147955608404, 604462909807314, 1911479556084045, 6044629098073146, 6653288015630616, 7323235338466790, 8060642451758603, 8872302163198820, 9765691276621298, 10749039466425620, 11831405087254648, 13022758617264914, 14334074503647984, 15777432256460256, 17366127722012378, 19114795560840448, 21039544058494708, 23158103510989148, 25489989551801104, 28056682924947216, 30881827360160752, 33991447372945972, 37414187995827888, 41181578649142096, 45328323582075176, 49892621559424256, 54916517738950528, 60446290980731456, 66532880156306032, 73232353384667904, 80606424517586032, 88723021631988016, 97656912766212992, 107490394664256192, 118314050872546240, 130227586172649136, 143340745036479856, 157774322564602240, 173661277220123776, 191147955608404480, 210395440584946624, 231581035109891488, 254899895518011040, 280566829249471584, 308818273601607552, 339914473729459712, 374141879958278144, 411815786491420928, 453283235820751744, 498926215594241536, 549165177389505280, 604462909807314560, 665328801563060352, 732323533846679040, 806064245175860224, 887230216319880192, 976569127662129920, 1074903946642562048, 1183140508725462528, 1302275861726491392, 1433407450364798464, 1577743225646022400, 1736612772201237760, 1911479556084044800, 2103954405849466368, 2315810351098914816, 2548998955180110336, 2805668292494715904, 3088182736016075264, 3399144737294597120, 3741418799582781440, 4118157864914209280, 4532832358207517184, 4989262155942415360, 5491651773895053312, 6044629098073145344, 6653288015630603264, 7323235338466789376, 8060642451758603264, 8872302163198801920, 9765691276621297664, 10749039466425620480, 11831405087254624256, 13022758617264914432, 14334074503647985664, 15777432256460224512, 17366127722012377088, 19114795560840450048, 21039544058494664704, 23158103510989152256, 25489989551801102336, 28056682924947156992, 30881827360160751616, 33991447372945973248, 37414187995827814400, 41181578649142091776, 45328323582075174912, 49892621559424155648, 54916517738950524928, 60446290980731453440, 66532880156306030592, 73232353384667897856, 80606424517586026496, 88723021631988023296, 97656912766212980736, 107490394664256208896, 118314050872546246656, 130227586172649144320, 143340745036479856640, 157774322564602232832, 173661277220123770880, 191147955608404492288, 210395440584946647040, 231581035109891506176, 254899895518011031552, 280566829249471578112, 308818273601607499776, 339914473729459748864, 374141879958278111232, 411815786491420934144, 453283235820751683584, 498926215594241556480, 549165177389505314816, 604462909807314599936, 665328801563060338688, 732323533846678994944, 806064245175860330496, 887230216319880134656, 976569127662129774592, 1074903946642561957888, 1183140508725462433792, 1302275861726491312128, 1433407450364798566400, 1577743225646022393856, 1736612772201237577728, 1911479556084044922880, 2103954405849466404864, 2315810351098914930688, 2548998955180110643200, 2805668292494716043264, 3088182736016075390976, 3399144737294597488640, 3741418799582781374464, 4118157864914209210368, 4532832358207517097984, 4989262155942415302656, 5491651773895053148160, 6044629098073145999360, 6653288015630603124736, 7323235338466790211584, 8060642451758603304960, 8872302163198802395136, 9765691276621298794496, 10749039466425620627456, 11831405087254623813632, 13022758617264913645568, 14334074503647983566848, 15777432256460225511424, 17366127722012377874432, 19114795560840447655936, 21039544058494662475776, 23158103510989150355456, 25489989551801103286272, 28056682924947158335488, 30881827360160754958336, 33991447372945971740672, 37414187995827814793216, 41181578649142095249408, 45328323582075170979840, 49892621559424153026560, 54916517738950525190144, 60446290980731462090752, 66532880156306033344512, 73232353384667900018688, 80606424517586030952448, 88723021631988017659904, 97656912766212987944960, 107490394664256189497344, 118314050872546242330624, 130227586172649140649984, 143340745036479844057088, 157774322564602238337024, 173661277220123782938624, 191147955608404493336576, 210395440584946633146368, 231581035109891511943168, 254899895518011024474112, 280566829249471583354880, 308818273601607516028928, 339914473729459734183936, 374141879958278114377728, 411815786491420902162432, 453283235820751760130048, 498926215594241513488384, 549165177389505251901440, 604462909807314587353088, 6044629098073145873530880, 60446290980731458735308800, 604462909807314587353088000, 6044629098073145873530880000, 60446290980731458735308800000, 604462909807314587353088000000, 6044629098073145873530880000000, 60446290980731458735308800000000, 604462909807314587353088000000000, 6044629098073145873530880000000000, 60446290980731458735308800000000000, 604462909807314587353088000000000000, 6044629098073145873530880000000000000, 60446290980731458735308800000000000000, 604462909807314587353088000000000000000, 6044629098073145873530880000000000000000, 60446290980731458735308800000000000000000, 604462909807314587353088000000000000000000, 6044629098073145873530880000000000000000000, 60446290980731458735308800000000000000000000, 604462909807314587353088000000000000000000000, 6044629098073145873530880000000000000000000000, 60446290980731458735308800000000000000000000000, 604462909807314587353088000000000000000000000000, 6044629098073145873530880000000000000000000000000, 60446290980731458735308800000000000000000000000000, 604462909807314587353088000000000000000000000000000, 6044629098073145873530880000000000000000000000000000, 60446290980731458735308800000000000000000000000000000, 604462909807314587353088000000000000000000000000000000, 6044629098073145873530880000000000000000000000000000000];

    return out;
}
